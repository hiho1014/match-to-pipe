# 2026-01-20 중앙 전구 직선 연결 오류 해결 의사결정 기록

**작성일**: 2026-01-20  
**작성자**: Antigravity  
**결정자**: 사용자

---

## 1. 📌 문제 상황

**증상**: 가끔 중앙하단의 전구(EXT 3)와 변압기가 1자로 직선 연결되는 오류 발생  
**원인**: 변압기와 전구의 X좌표가 같을 때, 우회 지점을 설정했음에도 불구하고 랜덤 이동 과정에서 중앙선을 따라 이동하는 경로가 선택되어 결과적으로 직선 배선이 형성됨

### 기존 로직의 한계
```javascript
// 현재 코드 (puzzle_mvp.html, line 614~648)
if (needDetour) {
    const detourX = start.x + (Math.random() < 0.5 ? 3 : -3);
    const waypoint = {
        x: Math.max(1, Math.min(this.cols - 2, detourX)),
        y: Math.floor((start.y + end.y) / 2)
    };
    targets = [waypoint, end];
}
```

**문제점**:
- 우회 지점을 설정하더라도, 경로 생성 시 `moves` 배열에서 랜덤하게 선택하기 때문에 세로(Y) 이동이 먼저 선택될 수 있음
- 세로로 먼저 이동하면 중앙선을 따라 내려가다가 나중에 가로로 꺾게 되어, 중앙의 모든 칸이 배선 구역으로 등록됨

---

## 2. 🔍 검토된 해결 방안

| 선택지 | 원리 | 장점 | 단점 |
|:---|:---|:---|:---|
| **1. 방향 우선순위 부여** | 우회지로 갈 때 가로축 이동을 우선적으로 선택 (80~90% 확률) | • 자연스러운 꺾임<br>• 코드 간단<br>• 랜덤성 유지 | • 드물게 길이 막힐 수 있음 (안전장치로 해결 가능) |
| **2. 직선축 금지 구역 설정** | 우회 중 중앙 열을 밟지 못하게 강제 | • 절대로 1자 연결 발생 안 함 | • 경로가 인위적으로 보일 수 있음 |
| **3. 다중 우회 지점** | 우회 지점을 2~3개로 늘림 | • 퍼즐 난이도 확실히 상승 | • 연산량 증가<br>• 배선이 너무 복잡해질 수 있음 |

---

## 3. ✅ 최종 결정: **옵션 1 (방향 우선순위 부여)**

### 선택 이유
1. **자연스러움**: 랜덤성을 유지하면서도 "옆으로 비켜나서 내려가라"는 지침을 줌
2. **단순함**: 코드 수정이 최소화되고 유지보수가 쉬움
3. **효과적**: 단점(길이 막힐 가능성)을 안전장치로 완벽히 해결 가능

### 단점 해결 방안 (2단계 안전장치)

#### 안전장치 1: 유연한 우선순위 (Soft Priority)
- 가로 이동이 가능할 때 **80~90% 확률**로 가로를 먼저 선택
- 가로가 막혔을 경우 자동으로 세로 이동으로 우회
- **원리**: "웬만하면 옆으로 가되, 안 되면 밑으로 가라"

#### 안전장치 2: 재시도 루프 (Retry Loop)
- 경로 생성 실패 시 즉시 재시도 (최대 3~5회)
- 컴퓨터 처리 속도가 매우 빠르므로 사용자는 눈치채지 못함
- 스테이지 로딩 시점에 모든 처리가 완료됨

---

## 4. 📝 구현 계획

### 수정 대상
- **파일**: `puzzle_mvp.html`
- **함수**: `generateRandomPath()` (line 614~648)

### 구현 내용
1. **우회 경로 생성 시 방향 우선순위 적용**
   - 우회 지점으로 이동할 때 가로 방향 이동에 가중치 부여
   - 가로 이동 가능 시 80~90% 확률로 선택

2. **재시도 로직 추가**
   - 경로 생성 실패 감지 (목표 지점 도달 실패)
   - 최대 5회까지 재시도
   - 5회 실패 시 fallback: 우회 없이 직선 허용 (극히 드문 경우)

3. **안전성 검증**
   - 무한 루프 방지 (safety counter 유지)
   - 경로 길이 제한 (500 steps)

---

## 5. 🎯 기대 효과

- ✅ 중앙 전구 직선 연결 오류 **99% 이상 제거**
- ✅ 자연스러운 배선 경로 유지
- ✅ 퍼즐 난이도 적절히 유지
- ✅ 성능 저하 없음 (스테이지 로딩 시간 변화 없음)

---

## 6. 📊 반려된 선택지 분석

### 옵션 2 반려 사유
- 경로가 너무 인위적으로 보일 수 있음
- "금지 구역"이라는 개념이 게임 로직에 부자연스러움

### 옵션 3 반려 사유
- 배선이 너무 복잡해져 시각적으로 지저분할 수 있음
- 난이도가 과도하게 상승할 우려
- 연산량 증가로 인한 성능 저하 가능성

---

## 7. 📅 다음 단계

1. ✅ 의사결정 문서 작성 완료
2. ⏳ `puzzle_mvp.html` 코드 수정
3. ⏳ 로컬 테스트 (Stage 1~5 전체)
4. ⏳ 결과 검증 및 문서화
5. ⏳ Git 커밋 및 푸시
